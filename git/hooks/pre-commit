#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -e

# 1. Branch Protection
CURRENT_BRANCH=$(git branch --show-current)
if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" ]]; then
  echo "‚ùå ERROR: Direct commits to '$CURRENT_BRANCH' are forbidden. Use a feature branch."
  exit 1
fi

# 2. Security Scan (PII-Guard)
echo "üõ°Ô∏è Running PII-Guard (Template-Aware)..."

# Capture result to catch 'FAIL' strings or exit status 1
# We explicitly trigger the 'HEADLESS' logic in the SKILL.md
RESULT=$(gemini -m gemini-3-pro-preview -p """
  - !!!You are not to add any additional file to the commit!!!
  - pii-guard scan
  - Ignore patterns wrapped in {}
  - Return 'FAIL' if real PII found
  - !!!You are not to add any additional file to the commit!!!
  """)

if [[ "$RESULT" == *"FAIL"* ]] || [[ "$RESULT" == *"status 1"* ]] || [[ "$RESULT" == *"VIOLATION"* ]]; then
  echo "‚ùå COMMIT BLOCKED: PII/PHI detected by security agent."
  echo "----------------------------------------------------"
  echo "$RESULT"
  exit 1
fi

# 3. Documentation Sync
if [ -f "scripts/doc_manager.py" ]; then
  echo "üîÑ Syncing documentation & verifying integrity..."
  # doc_manager now includes verify_git_integrity internally
  python3 scripts/doc_manager.py
  
  # Automatically stage manifest updates if successful
  if [ -f "docs_manifest.json" ]; then
    git add docs_manifest.json docs/README.md
  fi
fi

echo "‚úÖ All staff checks passed. Proceeding with commit."
